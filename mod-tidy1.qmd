# tidymodels

```{r}
#| echo: false

source("common.R")
source("mod-common.R")
status("writing")
```

本章为[Tidy Modeling with R](https://www.tmwr.org/)的学习笔记。

## 介绍

一个模型的效用取决于它的还原能力，或将复杂关系简化的能力。 随着模型变得更加强大和复杂，也更容易犯隐蔽性错误。同样的原则也适用于编程。软件应该尽可能地保护用户不犯错误，使其轻松地做正确的事。易于正确适用和良好的方法实践是模型开发至关重要的两点。

### 模型分类

按使用目的分类，模型可以大致分为：

-   **描述模型**：用于描述或说明数据的特征，这样的分析可能没有其他目的，只是直观地强调数据中的趋势或假象。

-   **推断模型**：用于为研究问题产生结论或探索特定的假设，类似于统计推断。

-   **预测模型**：用于对新数据进行尽可能地预测。按照模型开发方式，可以分为*mechanistic model*（机械性模型，利用数据估计方程未知参数）和*empirically driven model*(经验驱动模型，往往属于机器学习的范畴)。

将统计显著性作为衡量模型质量的唯一标准很危险。经过统计优化的模型可能具有较差的准确性或在其他衡量预测能力的指标上表现不佳。

预测性能往往与模型的拟合值和观测数据的接近程度有关。虽然描述模型和推断模型的主要目的可能与预测无关，但是不应该忽视它们的预测能力。如果有一个P值显著但是预测准确率惨淡的模型，我们应该多大程度上相信推论呢？

### 建模如何融入数据分析过程

在建模之前，有几个关键阶段：

1.  **数据清洗**：审查数据以确保数据符合项目的目标，具有准确性和恰当性。

2.  **探索性数据分析**（EDA）：了解不同变量之间的关系，变量的分布、范围等属性。这个阶段要问的一个好问题是："我是如何得到这些数据的？"。这个问题可以帮助了解手上的数据是如何抽样和筛选，以及这样的操作是否恰当。EDA可能与数据清洗有部分重叠。

3.  明确模型目标和判断模型性能的方法，至少需要设定一个有针对性的性能指标。

@fig-model-process 展示了确定适当模型的典型路径。一般的阶段是：

- 探索性数据分析（EDA）
- 特征工程（将从EDA中获得的理解进行建模）
- 模型调整和选择（图中大圆部分）
- 模型评估

```{r}
#| label: fig-model-process
#| fig-cap: 建模典型流程
#| echo: false

knitr::include_graphics("images/mod-tidy/modeling-process.svg")
```

探索性数据分析对建立高质量的模型至关重要。

## 模型基础

```{r}
library(tidymodels)
library(ggplot2)
data(ames, package = "modeldata")
```

Ames数据集包含了爱荷华州Ames市lowa的`r format(nrow(ames), big.mark = ",")`个房产信息，主要包括：

- 房屋特征（卧室、车库、壁炉、游泳池、门廊等）
- 地点（社区）
- 地段信息（分区、形状、大小等）
- 条件和质量的评级
- 销售价格

我们根据掌握的信息，预测房子的销售价格。

### 探索性数据分析（EDA）

```{r}
#| label: fig-ames-price
#| fig-height: 3
#| fig-cap: Ames市lowa的房屋售价

ggplot(ames, aes(Sale_Price)) +
  geom_histogram(bins = 50, col = "white")
```

数据是右偏的，便宜的房子比贵的房子数量多。售价中位数是`r format(median(ames$Sale_Price), big.mark = ",")`，美元，最贵的房屋为`r format(max(ames$Sale_Price), big.mark = ",")`美元。对这样的结果建模时，应该进行对数转换，这样就没有预测房屋售价为负数的情况，也可以防止预测售价昂贵的房子对模型产生影响。另外，从统计学的角度来看，对数转换也可以稳定方差，使推论更加合理。

```{r}
#| label: fig-ames-price-log10
#| fig-height: 3
#| fig-cap: Ames市lowa的房屋售价对数（以10为底）

ggplot(ames, aes(Sale_Price)) +
  geom_histogram(bins = 50, col = "white") +
  scale_x_log10()
```

::: callout-note
转换的缺点主要在于转换后的模型难以解释，包括模型系数的单位、性能衡量。
:::

```{r}
ames <- ames %>% mutate(Sale_Price = log10(Sale_Price))
```

























