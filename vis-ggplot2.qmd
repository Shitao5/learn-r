# ggplot2

```{r}
#| include: false

source("common.R")
status("writing")
columns(1, 2/3)
```

<!-- columns函数控制绘图输出，用法如下： -->
<!-- `r columns(1, 2/3)` -->
<!-- `r columns(2, 2/3)` -->
<!-- `r columns(3, 1)` -->
<!-- `r columns(4, 1)` -->

```{r}
#| message: false
library(ggplot2)
```

ggplot2[@ggplot2]具有底层的图形语法，[*ggplot2: Elegant Graphics for Data Analysis*](https://ggplot2-book.org/)重点解释了这套语法，
本章节为其学习笔记。

## ggplot2初步

ggplot2具有颜色（color）、大小（size）、形状（shape）、填充（fill）等美学属性，适用于不同类型的图形。

在绘图美学中，少即是多，使用美学映射需要节制。与其用一幅非常复杂的图形一次展示所有，不如创造一些简单的情节，讲述一个故事，让读者的认识从无到有。

## 图层（Layers）

ggplot2的分层结构[^layers]使得我们可以以结构化的方式设计和构建图形。一般来说，图层有三个功能：

[^layers]: 和Photoshop的图层类似。

1. 展示数据
1. 展示数据的统计摘要
1. 添加额外的元数据：背景、注释和参考文献。

### 基本图形

`r columns(4, 1)`
```{r}
#| label: basic-plot
#| layout-ncol: 4
#| layout-nrow: 2

df <- data.frame(
  x = c(3, 1, 5),
  y = c(2, 4, 6),
  label = c("a", "b", "c")
)

p <- ggplot(df, aes(x, y, label = label)) +
  labs(x = NULL, y = NULL) +
  theme(plot.title = element_text(size = 12))

p + geom_point() + ggtitle("point")
p + geom_text() + ggtitle("text")
p + geom_bar(stat = "identity") + ggtitle("bar")
p + geom_tile() + ggtitle("raster")

p + geom_line() + ggtitle("line")
p + geom_area() + ggtitle("area")
p + geom_path() + ggtitle("path")
p + geom_polygon() + ggtitle("polygon")
```

### 揭示不确定性

根据x轴是否连续和是否展示中间值，比较基本的有：

`r columns(3, 1)`
```{r}
#| label: summaries-plot
#| layout-ncol: 3
#| layout-nrow: 2

df <- data.frame(x = 1:3,
                 y = c(18, 11, 16),
                 se = c(1.2, .5, 1.0))

base <- ggplot(df, aes(x, y,
                       ymin = y - se,
                       ymax = y + se))
base + geom_crossbar()
base + geom_pointrange()
base + geom_smooth(stat = "identity")

base + geom_errorbar()
base + geom_linerange()
base + geom_ribbon()
```

### 权重数据

汇总数据的每一行代表多个观测值，因此需要考虑权重变量。权重变量的选择将影响绘图和得出的结论。

对于点图、线图等简单图形，使用大小（size)美学。

`r columns(2, 2/3)`
```{r}
#| label: weighted-data
#| layout-ncol: 2

# Unweighted
ggplot(midwest, aes(percwhite, percbelowpoverty)) +
  geom_point()

# Weighted by population
ggplot(midwest, aes(percwhite, percbelowpoverty)) +
  geom_point(aes(size = poptotal / 1e6)) +
  scale_size_area("Population\n(millions)",
                  breaks = c(.5, 1, 2, 4))
```

对于涉及统计转换等复杂图形，使用`weight`美学指定权重。权重支持平滑、量化回归、箱型图、直方图、密度图等情形。我们无法直接从图中看出权重变量，它也不会产生图例，但会改变统计汇总的结果。

```{r}
#| message: false
#| layout-ncol: 2

# Unweighted
ggplot(midwest, aes(percwhite, percbelowpoverty)) +
  geom_point() +
  geom_smooth(method = lm, size = 1)

# Weighted by population
ggplot(midwest, aes(percwhite, percbelowpoverty)) +
  geom_point(aes(size = poptotal / 1e6)) +
  geom_smooth(aes(weight = poptotal), method = lm, size = 1) +
  scale_size_area(guide = "none")
```

### 地图

绘制地理空间数据是一项常见的可视化任务，它需要专门的工作。通常来讲，可以把任务分成两步：

1. 使用数据源绘制地图；
1. 从信息源添加元数据到地图上。

R语言内置了地图包，虽然不是最新的，但是一个好的起点。这里从中提取密歇根州的县界：

```{r}
#| message: false
library(tidyverse) # 用于数据处理
mi_counties <- map_data("county", "michigan") %>% 
  select(lon = long, lat, group, id = subregion)
head(mi_counties)
```

利用散点图可以看到数据集中每个县的角落，通过`geom_polygon()`将散点图绘制成地图：

```{r}
#| layout-ncol: 2

ggplot(mi_counties, aes(lon, lat)) +
  geom_point(size = .25, show.legend = FALSE) +
  coord_quickmap()

ggplot(mi_counties, aes(lon, lat, group = group)) +
  geom_polygon(fill = "white", color = "grey50") +
  coord_quickmap()
```

`coord_quickmap()`调整坐标轴，以确保经度和纬度在同一比例上呈现。但地理空间数据往往需要更精准的方法，因此ggplot2提供了`geom_sf()`和`coord_sf()`来处理简单特征格式的空间数据。

#### sf

































